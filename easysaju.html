<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>이지사주 무료운세</title>
    <link rel="icon" type="image/png" sizes="32x32" href="https://easysajusaju-dev.github.io/images/favicon-32x32.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .form-container { max-width: 800px; margin: auto; padding: 20px; }
        .form-group { margin-bottom: 1.5rem; }
        .form-group label { display: block; font-weight: bold; margin-bottom: 0.5rem; color: #333; }
        .form-group input, .form-group select { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; }
        .birth-select, .button-group { display: flex; gap: 8px; flex-wrap: wrap; }
        .birth-select select { flex: 1; min-width: 100px; }
        .button-group { display: flex; gap: 12px; flex-wrap: wrap; }
        .button-group input[type="radio"] { display: none; }
        .button-group label { padding: 10px 16px; background: #f0f0f0; border-radius: 8px; cursor: pointer; font-size: 14px; }
        .button-group input:checked + label { background: #3b82f6; color: white; }
        .agree-section { margin: 2rem 0; padding: 1rem; background: #f9f9f9; border-radius: 12px; }
        .agree-box { margin-bottom: 1rem; }
        .terms-box { width: 100%; height: 80px; margin-top: 8px; padding: 10px; background: white; border: 1px solid #ddd; border-radius: 8px; font-size: 12px; display: none; }
        .toggle-text { color: #3b82f6; margin-left: 4px; cursor: pointer; }
        .fetch-btn { width: 100%; padding: 14px; background: linear-gradient(to right, #8b5cf6, #ec4899); color: white; font-weight: bold; border: none; border-radius: 12px; cursor: pointer; font-size: 16px; }
        .saju-input { background: #f3f4f6; font-weight: bold; text-align: center; }
        #submitBtn { width: 100%; padding: 16px; background: #fbbf24; color: white; font-weight: bold; font-size: 18px; border: none; border-radius: 12px; cursor: pointer; margin-top: 1rem; }
        #submitBtn:disabled { background: #ccc; cursor: not-allowed; }
        .kakao-chat-button { position: fixed; bottom: 25px; right: 25px; z-index: 999; width: 60px; height: 60px; background: #FEE500; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        #result { margin-top: 20px; padding: 16px; background: #f0f9ff; border-radius: 12px; min-height: 50px; }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="form-container">
            <form id="saju-form" action="https://script.google.com/macros/s/AKfycbzij2Oorrv6DqmmEGcTXrDkj7wqbmpr_Wl2C3nXJGARLcc1oFdZtUaH8AkFVgZdrajo/exec" method="POST">
                
                <!-- 이름 -->
                <div class="form-group">
                    <label>이름</label>
                    <input type="text" name="p1_name" placeholder="이름" required>
                </div>

                <!-- 연락처 -->
                <div class="form-group">
                    <label for="contact">연락처</label>
                    <input type="tel" id="contact" name="contact" placeholder="'-' 없이 숫자만 입력" required maxlength="11" pattern="^01[0-9]{8,9}$">
                </div>

                <!-- 생년월일 -->
                <div class="form-group">
                    <label>생년월일</label>
                    <div class="birth-select">
                        <select id="p1_birth_year" required><option value="">-년-</option></select>
                        <select id="p1_birth_month" required><option value="">-월-</option></select>
                        <select id="p1_birth_day" required><option value="">-일-</option></select>
                    </div>
                </div>

                <!-- 양/음력 -->
                <div class="form-group">
                    <label>양/음력</label>
                    <div class="button-group">
                        <input type="radio" id="p1_solar" name="p1_solarlunar" value="양력" checked><label for="p1_solar">양력</label>
                        <input type="radio" id="p1_lunar" name="p1_solarlunar" value="음력"><label for="p1_lunar">음력</label>
                        <input type="radio" id="p1_lunar_leap" name="p1_solarlunar" value="음력(윤달)"><label for="p1_lunar_leap">음력(윤달)</label>
                    </div>
                </div>

                <!-- 성별 -->
                <div class="form-group">
                    <label>성별</label>
                    <div class="button-group">
                        <input type="radio" id="p1_male" name="p1_gender" value="남자" checked><label for="p1_male">남자</label>
                        <input type="radio" id="p1_female" name="p1_gender" value="여자"><label for="p1_female">여자</label>
                    </div>
                </div>

                <!-- 출생 시간 -->
                <div class="form-group">
                    <label>태어난 시간</label>
                    <div class="birth-select">
                        <select id="p1_hour"><option value="">모름</option></select>
                        <select id="p1_minute"><option value="0">00분</option></select>
                    </div>
                </div>

                <!-- 이메일 -->
                <div class="form-group">
                    <label for="email">이메일 (선택)</label>
                    <input type="email" name="email" placeholder="분석 결과 수신용 이메일 주소">
                </div>

                <!-- 상품 선택 -->
                <div class="form-group">
                    <label for="product">상품 선택</label>
                    <select id="product" name="product" required>
                        <option value="종합사주 미니">종합사주 미니</option>
                        <option value="신년운세">신년운세</option>
                        <option value="종합사주">종합사주</option>
                    </select>
                </div>

                <!-- 사주 자동 입력 버튼 -->
                <div class="form-group">
                    <button type="button" id="fetchSajuBtn" class="fetch-btn">사주 자동 입력하기</button>
                </div>

                <!-- 사주 정보 -->
                <div class="p-5 rounded-2xl shadow-sm border border-gray-200 bg-gray-50 mb-6">
                    <h3 class="font-bold text-lg mb-3 text-gray-800">사주 정보 (자동 입력)</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
                        <input id="yearJoo" name="yearJoo" required placeholder="년주" class="saju-input" readonly>
                        <input id="monthJoo" name="monthJoo" required placeholder="월주" class="saju-input" readonly>
                        <input id="dayJoo" name="dayJoo" required placeholder="일주" class="saju-input" readonly>
                        <input id="timeJoo" name="timeJoo" required placeholder="시주" class="saju-input" readonly>
                    </div>
                </div>

                <!-- 동의 -->
                <div class="agree-section">
                    <div class="agree-box">
                        <input type="checkbox" id="agree_all">
                        <label for="agree_all">전체동의</label>
                    </div>
                    <div class="agree-box">
                        <input type="checkbox" id="agree1" class="agree-item" required>
                        <label for="agree1">[필수] 개인정보 수집·이용 동의 <span class="toggle-text">[보기]</span></label>
                        <textarea class="terms-box" readonly>[필수] 개인정보 수집·이용 동의

1. 수집 항목: 이름, 생년월일시, 성별, 전화번호
2. 이용 목적: 사주 분석 및 결과 전송
3. 보유 기간: 1년
4. 동의 거부 시 서비스 이용 불가</textarea>
                    </div>
                </div>

                <!-- UTM -->
                <input type="hidden" id="utm_source" name="utm_source">
                <input type="hidden" id="utm_medium" name="utm_medium">
                <input type="hidden" id="utm_campaign" name="utm_campaign">

                <!-- 제출 -->
                <button type="submit" id="submitBtn">사주분석 신청하기</button>
                <div id="result"></div>
            </form>
        </div>
    </div>

    <a href="http://pf.kakao.com/_xkAevn/chat" target="_blank" class="kakao-chat-button">
        <img src="https://easysajusaju-dev.github.io/images/icons8-카카오-톡-48.png" alt="카카오톡">
    </a>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const yearSel = document.getElementById('p1_birth_year');
            const monthSel = document.getElementById('p1_birth_month');
            const daySel = document.getElementById('p1_birth_day');
            const hourSel = document.getElementById('p1_hour');
            const minuteSel = document.getElementById('p1_minute');

            for (let y = new Date().getFullYear(); y >= 1900; y--) yearSel.add(new Option(y + '년', y));
            for (let m = 1; m <= 12; m++) monthSel.add(new Option(m + '월', m));
            function updateDays() {
                const y = yearSel.value, m = monthSel.value;
                daySel.innerHTML = '<option value="">-일-</option>';
                if (y && m) {
                    const days = new Date(y, m, 0).getDate();
                    for (let d = 1; d <= days; d++) daySel.add(new Option(d + '일', d));
                }
            }
            yearSel.onchange = monthSel.onchange = updateDays;
            for (let h = 0; h < 24; h++) hourSel.add(new Option(h + '시', h));
            for (let m = 0; m < 60; m++) minuteSel.add(new Option(m + '분', m));

            const hanziToHangul = {
                '甲': '갑', '乙': '을', '丙': '병', '丁': '정', '戊': '무',
                '己': '기', '庚': '경', '辛': '신', '壬': '임', '癸': '계',
                '子': '자', '丑': '축', '寅': '인', '卯': '묘', '辰': '진',
                '巳': '사', '午': '오', '未': '미', '申': '신', '酉': '유',
                '戌': '술', '亥': '해'
            };

            const clean = (s) => {
                if (!s) return '';
                let result = '';
                for (let char of s.toString()) {
                    result += hanziToHangul[char] || char;
                }
                return result.trim().replace(/[^가-힣]/g, '');
            };

            // 사주 자동 입력
            document.getElementById('fetchSajuBtn').onclick = async () => {
                const y = yearSel.value, m = monthSel.value, d = daySel.value;
                const h = hourSel.value || 0;
                const min = minuteSel.value || 0;
                const isMale = document.getElementById('p1_male').checked;
                const isSolar = document.getElementById('p1_solar').checked;
                const isLeap = document.getElementById('p1_lunar_leap').checked;

                if (!y || !m || !d) return alert('생년월일을 모두 선택하세요.');

                const params = new URLSearchParams({
                    year: y, month: m, day: d, hour: h, min: min,
                    isMale: isMale, isLunar: !isSolar, leap: isLeap, pivotMin: 30
                });

                const url = `https://saju-proxy.onrender.com/proxy/saju?${params}`;
                try {
                    const res = await fetch(url);
                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    const data = await res.json();

                    const year = clean(data.yearGanji);
                    const month = clean(data.monthGanji);
                    const day = clean(data.dayGanji);
                    const hour = clean(data.hourGanji);

                    document.getElementById('yearJoo').value = year;
                    document.getElementById('monthJoo').value = month;
                    document.getElementById('dayJoo').value = day;
                    document.getElementById('timeJoo').value = hour;

                    alert(`사주 입력 완료!\n${year} ${month} ${day} ${hour}`);
                } catch (e) {
                    alert('만세력 API 오류. 다시 시도하세요.');
                }
            };

            // 동의 토글
            document.querySelectorAll('.toggle-text').forEach(t => {
                t.onclick = () => {
                    const box = t.parentElement.nextElementSibling;
                    box.style.display = box.style.display === 'block' ? 'none' : 'block';
                };
            });

            document.getElementById('agree_all').onchange = function() {
                document.querySelectorAll('.agree-item').forEach(c => c.checked = this.checked);
            };

            const params = new URLSearchParams(location.search);
            ['utm_source','utm_medium','utm_campaign'].forEach(k => {
                document.getElementById(k).value = params.get(k) || '';
            });

            const KAKAO_URL = "https://pf.kakao.com/_xkAevn/friend";
            const submitBtn = document.getElementById('submitBtn');
            const resultDiv = document.getElementById('result');
            const today = new Date().toDateString();

            if (localStorage.getItem("joinedChannelDate") !== today) localStorage.removeItem("joinedChannel");
            if (localStorage.getItem("joinedChannel")) switchToResultMode();

            function switchToResultMode() {
                submitBtn.textContent = "무료 사주 분석 결과보기";
                submitBtn.onclick = () => runAnalysis();
            }

            // 제출 → GAS가 중복 체크 + 결과 반환
            function runAnalysis() {
                const saju = [
                    document.getElementById('yearJoo').value,
                    document.getElementById('monthJoo').value,
                    document.getElementById('dayJoo').value,
                    document.getElementById('timeJoo').value
                ];
                if (saju.some(v => v.length !== 2)) {
                    alert("사주를 자동 입력 후 제출하세요.");
                    return;
                }

                submitBtn.disabled = true;
                resultDiv.innerHTML = "분석 중입니다...";

                // 폼 제출 → GAS가 중복 체크 + 결과 반환
                document.getElementById('saju-form').submit();
            }

            submitBtn.onclick = (e) => {
                e.preventDefault();
                if (!document.getElementById('agree1').checked) return alert("개인정보 동의 필수");

                if (!localStorage.getItem("joinedChannel")) {
                    const popup = window.open(KAKAO_URL, "kakao", "width=480,height=720");
                    const timer = setInterval(() => {
                        if (popup.closed) {
                            clearInterval(timer);
                            localStorage.setItem("joinedChannel", "true");
                            localStorage.setItem("joinedChannelDate", today);
                            switchToResultMode();
                        }
                    }, 800);
                } else {
                    runAnalysis();
                }
            };

            // GAS 응답 처리 (기존 방식)
            window.addEventListener('load', () => {
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('result')) {
                    resultDiv.innerHTML = decodeURIComponent(urlParams.get('result'));
                    history.replaceState({}, '', window.location.pathname);
                }
            });
        });
    </script>
</body>
</html>
