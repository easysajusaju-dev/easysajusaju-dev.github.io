<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>사주 조회(생년월일시 → 4주 자동)</title>
  <style>
    :root{--line:#e5e7eb;--muted:#6b7280}
    *{box-sizing:border-box}
    body{font-family:system-ui,Segoe UI,Apple SD Gothic Neo,Malgun Gothic,Arial;
         max-width:980px;margin:32px auto;line-height:1.55;padding:0 16px}
    h1{margin:0 0 10px}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin:6px 0}
    .row>label{flex:1 1 140px}
    input[type=number],input[type=text]{width:100%;padding:8px;border:1px solid var(--line);border-radius:6px}
    fieldset{border:1px solid var(--line);border-radius:10px;padding:12px;margin:12px 0}
    legend{color:var(--muted)}
    button{padding:10px 16px;border:1px solid var(--line);border-radius:8px;background:#111;color:#fff;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    table{border-collapse:collapse;width:100%;margin:12px 0}
    th,td{border:1px solid var(--line);padding:8px;text-align:left}
    th{background:#fafafa}
    pre{background:#0b1220;color:#e6edf3;padding:12px;border-radius:8px;overflow:auto}
    .note{color:var(--muted);font-size:.92rem}
    .split{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width:900px){.split{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <h1>사주 조회</h1>
  <p class="note">생년월일시(분)로 조회하면 아래 4주 입력칸에 자동으로 채워집니다.</p>

  <!-- 좌: 입력 / 우: 4주 결과 칸 -->
  <div class="split">
    <!-- 생년월일시 입력 -->
    <div>
      <fieldset>
        <legend>생년월일시 입력</legend>
        <div class="row">
          <label>년 <input id="i_year" type="number" value="1973"></label>
          <label>월 <input id="i_month" type="number" min="1" max="12" value="5"></label>
          <label>일 <input id="i_day" type="number" min="1" max="31" value="13"></label>
        </div>
        <div class="row">
          <label>시(0~23) <input id="i_hour" type="number" min="0" max="23" value="14"></label>
          <label>분(0~59) <input id="i_min" type="number" min="0" max="59" value="0"></label>
        </div>

        <div class="row">
          <label><input type="radio" name="cal" value="solar" checked> 양력</label>
          <label><input type="radio" name="cal" value="lunar"> 음력</label>
          <label><input id="i_leap" type="checkbox" disabled> 윤달</label>
        </div>

        <div class="row">
          <label><input type="radio" name="sex" value="male" checked> 남</label>
          <label><input type="radio" name="sex" value="female"> 여</label>
        </div>

        <div class="row">
          <label><input type="radio" name="pivot" value="0"> 시주 경계 정시(0분)</label>
          <label><input type="radio" name="pivot" value="30" checked> 시주 경계 반시(30분)</label>
        </div>

        <button id="btnQuery">조회해서 4주 자동 입력</button>
        <div id="msg" class="note" style="margin-top:6px"></div>
      </fieldset>

      <fieldset>
        <legend>대운/세운</legend>
        <table id="tblDae">
          <thead><tr><th>대운</th><th>간지</th><th>시작년도</th></tr></thead>
          <tbody></tbody>
        </table>
        <table id="tblSeun">
          <thead><tr><th>년도</th><th>간지</th></tr></thead>
          <tbody></tbody>
        </table>
      </fieldset>

      <details>
        <summary>원본 JSON 보기</summary>
        <pre id="raw">-</pre>
      </details>
    </div>

    <!-- 4주 수동 입력칸(자동 채움 대상) -->
    <div>
      <fieldset>
        <legend>4주(년/월/일/시)</legend>
        <div class="row">
          <label>년주 <input id="yearJu" type="text" placeholder="예: 癸丑"></label>
          <label>월주 <input id="monthJu" type="text" placeholder="예: 丁巳"></label>
        </div>
        <div class="row">
          <label>일주 <input id="dayJu" type="text" placeholder="예: 己酉"></label>
          <label>시주 <input id="hourJu" type="text" placeholder="예: 辛未"></label>
        </div>
        <p class="note">이 4개 칸은 자동 채워지며, 필요 시 직접 수정할 수도 있습니다.</p>
      </fieldset>
    </div>
  </div>

  <script>
    // [중요] 여기에 당신의 Render 주소를 넣으세요(https 포함, 끝에 슬래시 X)
    // 예: "https://my-manseryeok.onrender.com"
    const API_BASE = https://my-manseryeok.onrender.com";

    // 음력 선택 시에만 윤달 체크 가능
    document.querySelectorAll('input[name=cal]').forEach(r=>{
      r.addEventListener('change', ()=>{
        const isLunar = document.querySelector('input[name=cal]:checked').value === 'lunar';
        const leapEl = document.getElementById('i_leap');
        leapEl.disabled = !isLunar;
        if (!isLunar) leapEl.checked = false;
      });
    });

    function v(id, def=0){ const n = +document.getElementById(id).value; return Number.isFinite(n)?n:def; }
    function sel(name){ return document.querySelector(`input[name=${name}]:checked`).value; }
    function set(id, val){ const el=document.getElementById(id); if(el) el.value = val ?? ''; }
    function fillTable(tbody, rows){ tbody.innerHTML = rows.map(r=>`<tr>${r.map(c=>`<td>${c}</td>`).join('')}</tr>`).join(''); }

    document.getElementById('btnQuery').addEventListener('click', async ()=>{
      const msg = document.getElementById('msg');
      msg.textContent = '조회 중...';

      const y=v('i_year'), m=v('i_month'), d=v('i_day'), h=v('i_hour'), min=v('i_min');
      const isLunar = sel('cal') === 'lunar';
      const leap    = isLunar && document.getElementById('i_leap').checked;
      const isMale  = sel('sex') === 'male';
      const pivot   = +sel('pivot'); // 0 또는 30

      const qs = new URLSearchParams({year:y,month:m,day:d,hour:h,min,isLunar,leap,isMale,pivotMin:pivot});
      try{
        const res = await fetch(`${API_BASE}/saju?${qs.toString()}`, {cache:'no-store'});
        if(!res.ok) throw new Error('HTTP '+res.status);
        const data = await res.json();

        // 4주 자동 입력
        set('yearJu',  data.yearGanji);
        set('monthJu', data.monthGanji);
        set('dayJu',   data.dayGanji);
        set('hourJu',  data.hourGanji);

        // 대운/세운 표
        const daeBody = document.querySelector('#tblDae tbody');
        const daeRows = (data.daeWoon||[]).map((label,i)=>[
          label, (data.daeWoonGanji||[])[i]||'', (data.daeWoonYear||[])[i]||''
        ]);
        fillTable(daeBody, daeRows);

        const seunBody = document.querySelector('#tblSeun tbody');
        const seunRows = (data.seunYear||[]).map((yy,i)=>[ yy, (data.seunGanji||[])[i]||'' ]);
        fillTable(seunBody, seunRows);

        document.getElementById('raw').textContent = JSON.stringify(data,null,2);
        msg.textContent = `완료: ${data.yearGanji} / ${data.monthGanji} / ${data.dayGanji} / ${data.hourGanji}`;
      }catch(e){
        msg.textContent = '오류: ' + (e?.message || String(e));
      }
    });

    // Enter로도 조회 가능
    document.addEventListener('keydown', e=>{ if(e.key==='Enter') document.getElementById('btnQuery').click(); });
  </script>
</body>
</html>
