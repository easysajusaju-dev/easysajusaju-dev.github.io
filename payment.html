<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ê²°ì œí•˜ê¸° - ì´ì§€ì‚¬ì£¼</title>

<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap');
:root {
  --primary-color: #4a5a73;
  --kakao-yellow: #FEE500;
  --naver-green: #03C75A;
  --toss-blue: #0064FF;
  --text-dark: #212529;
  --text-light: #6C757D;
  --bg-light: #f8f9fa;
  --border-color: #dee2e6;
}
body { margin:0;font-family:'Noto Sans KR',sans-serif;background:var(--bg-light);color:var(--text-dark);}
.wrapper { max-width:480px;margin:0 auto;background:#fff;box-shadow:0 4px 12px rgba(0,0,0,0.08);}
.header {display:flex;align-items:center;justify-content:center;padding:1rem;border-bottom:1px solid var(--border-color);}
.back-btn {position:absolute;left:1rem;font-size:1.5rem;background:none;border:none;cursor:pointer;}
.banner {position:relative;height:140px;color:#fff;padding:1rem;display:flex;flex-direction:column;justify-content:center;}
.banner .bg-img {position:absolute;inset:0;width:100%;height:100%;object-fit:cover;}
.banner::after {content:"";position:absolute;inset:0;background:rgba(0,0,0,0.4);}
.banner .text-content {position:relative;}
.title {font-size:1.7rem;font-weight:700;margin:.2rem 0;}
main {padding:1.5rem;}
.card {background:#fff;padding:1.3rem;border-radius:12px;margin-bottom:1rem;}
.price-info {display:flex;justify-content:space-between;margin:8px 0}
.price-info.total {font-size:1.2rem;font-weight:700;border-top:1px solid var(--border-color);padding-top:10px;margin-top:10px}
.payment-buttons {display:flex;flex-direction:column;gap:.7rem;margin-top:1.2rem;}
.sns-payment-group {display:flex;gap:.7rem;flex-wrap:wrap;}
.btn {display:flex;align-items:center;justify-content:center;padding:.85rem;border:none;border-radius:8px;font-size:1rem;font-weight:700;cursor:pointer;flex:1;}
.btn-kakao {background:var(--kakao-yellow);}
.btn-naver {background:var(--naver-green);color:#fff;}
.btn-toss {background:var(--toss-blue);color:#fff;}
.btn-primary {background:var(--primary-color);color:#fff;}
.btn img {height:16px;margin-right:6px;}
</style>

<script src="https://pay.nicepay.co.kr/v1/js/"></script>
</head>

<body>
<div class="wrapper">
<header class="header">
  <button class="back-btn" onclick="history.back()">&lt;</button>
  <h1>ê²°ì œí•˜ê¸°</h1>
</header>

<div class="banner">
  <img src="/images/card-individual.png" class="bg-img">
  <div class="text-content">
    <p class="subtitle">ë‹¹ì‹ ì˜ ìš´ëª…ì„ í’€ì–´ë‚´ëŠ” ê³³</p>
    <h2 class="title">ì´ì§€ì‚¬ì£¼</h2>
    <p class="desc">ë³µì±„ ê²°ì œí•˜ê¸°</p>
  </div>
</div>

<main>
<div class="card">
  <h3 class="card-title">ê²°ì œ ê¸ˆì•¡</h3>
  <div class="price-info">
      <span class="label" id="pay-product-name">ìƒí’ˆëª…</span>
      <span class="amount" id="pay-product-price">0ì›</span>
  </div>
  <div class="price-info">
      <span class="label">í• ì¸ ì ìš©</span>
      <span class="amount" id="pay-discount">-0ì›</span>
  </div>
  <div class="price-info total">
      <span class="label">ìµœì¢… ê²°ì œê¸ˆì•¡</span>
      <span class="amount" id="pay-final-price">0ì›</span>
  </div>
</div>

<div class="payment-buttons">
  <div class="sns-payment-group">
    <button class="btn btn-kakao" onclick="requestPay('kakao')">
      <img src="images/á„á…¡á„á…¡á„‹á…©á„‘á…¦á„‹á…µ_CI_combination_with_BG.png">ì¹´ì¹´ì˜¤í˜ì´
    </button>
    <button class="btn btn-naver" onclick="requestPay('naver')">
      <img src="images/badge_npay.png">ë„¤ì´ë²„í˜ì´
    </button>
    <button class="btn btn-toss" onclick="requestPay('toss')">
      <img src="images/toss_logo.png">í† ìŠ¤í˜ì´
    </button>
  </div>
  <button class="btn btn-primary" onclick="requestPay('card')">ì¼ë°˜ê²°ì œ</button>
</div>
</main>
</div>

<script>
const API_BASE = "https://my-payment-server.vercel.app";

// âœ… URL íŒŒë¼ë¯¸í„° ì¶”ì¶œ
function getParam(k){ return new URLSearchParams(location.search).get(k); }

const oid     = getParam("oid");
const product = decodeURIComponent(getParam("product") || "");
const price   = Number(getParam("price") || 0);

// âœ… UI ì„¸íŒ…
document.addEventListener("DOMContentLoaded", () => {
  document.querySelector(".title").textContent = `ì´ì§€ì‚¬ì£¼ - ${product}`;
  document.getElementById("pay-product-name").textContent  = product;
  document.getElementById("pay-product-price").textContent = `${price.toLocaleString()}ì›`;
  document.getElementById("pay-final-price").textContent   = `${price.toLocaleString()}ì›`;
});

// âœ… ê²°ì œ ìš”ì²­ (ì¹´ë“œ + ì¹´ì¹´ì˜¤ + ë„¤ì´ë²„ + í† ìŠ¤)
function requestPay(type) {
  const oid = getParam("oid") || `order_${Date.now()}`;
  const product = decodeURIComponent(getParam("product") || "");
  const price = Number(getParam("price")) || 0;

  const methodMap = {
    card: "card",
    kakao: "kakaopay",
    naver: "naverpay",
    toss: "tosspay"
  };

  if (!methodMap[type]) {
    alert("ì§€ì›í•˜ì§€ ì•ŠëŠ” ê²°ì œìˆ˜ë‹¨ì…ë‹ˆë‹¤.");
    return;
  }

  AUTHNICE.requestPay({
    clientId: "R2_29330d4bbbe14f5c85925e52e48e0721",
    method: methodMap[type],
    orderId: oid,
    amount: price,
    goodsName: product,
    returnUrl: "https://my-payment-server.vercel.app/api/pay/callback",

    fnError: function (err) {
      console.error("âŒ ê²°ì œ ì˜¤ë¥˜:", err);
      alert("ê²°ì œê°€ ì·¨ì†Œë˜ì—ˆê±°ë‚˜ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    },

    fnSuccess: function (res) {
      console.log(`âœ… ${type} ì¸ì¦ ì„±ê³µ:`, res);

      // ğŸ”„ NICE ì„œë²„ ìŠ¹ì¸ ìš”ì²­ (ìë™)
      fetch(`${API_BASE}/api/pay/confirm`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(res)
      })
      .then(r => r.json())
      .then(data => {
        console.log("ğŸ‰ ê²°ì œ ìŠ¹ì¸ ì™„ë£Œ:", data);
        alert("ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
        location.href = "/pay/success.html";
      })
      .catch(e => {
        console.error("ìŠ¹ì¸ìš”ì²­ ì‹¤íŒ¨:", e);
        alert("ê²°ì œ ìŠ¹ì¸ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      });
    }
  });
}
</script>
</body>
</html>
